import React, { useState, useRef } from "react";
import { Link } from "react-router-dom";
import { useSelector, useDispatch } from "react-redux";
import {
    cartItemsAction,
    isItemDeletedAction,
    deletedItemIdAction,
    priceSumAction,
    clearCartAction,
    myOrdersAction,
    successOrderAction,
} from "../../store/reducers/cartReducer";
import "./Cart.scss";
import imgSuccess from "../../img/ok.png";

const Cart = () => {
    const dispatch = useDispatch();

    const cartItems = useSelector((state) => state.cartReducer.cartItems);
    const priceSum = useSelector((state) => state.cartReducer.priceSum);
    const clearCart = useSelector((state) => state.cartReducer.clearCart);
    const successOrder = useSelector((state) => state.cartReducer.successOrder);

    const [isCartOpen, setIsCartOpen] = useState(false);

    const overlayRef = useRef();

    const hideOnOverlay = (e) => {
        if (overlayRef.current === e.target) {
            setIsCartOpen(false);
        }

        if (successOrder) {
            dispatch(successOrderAction(false));
        }
    };

    const deleteItem = (item) => {
        dispatch(deletedItemIdAction(item.id));
        let filter = cartItems.filter((book) => {
            console.log("item", item);
            return book != item;
        });
        console.log("priceSum", priceSum);
        dispatch(priceSumAction(priceSum - item.price));
        dispatch(isItemDeletedAction(true));
        dispatch(cartItemsAction(filter));
        console.log(filter);
    };

    const clearingCart = () => {
        console.log("clear");
        dispatch(cartItemsAction([]));
        dispatch(clearCartAction(() => !clearCart));
        dispatch(priceSumAction(0));
    };

    const [orderNum, setOrderNum] = useState(0);

    const addToMyOrders = () => {
        setOrderNum(orderNum + 1);
        // let sum = priceSum
        let ordersArr = cartItems.map((item) => {
            return {
                orderSum: priceSum,
                orderNumber: orderNum + 1,
                title: item.title,
                authors: item.authors,
                price: item.price,
                id: item.id,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
            };
        });

        clearingCart();
        dispatch(myOrdersAction(ordersArr));
        dispatch(successOrderAction(true));
    };

    return (
        <div className="cart">
            <a onClick={() => setIsCartOpen(true)} className="cart__inner">
                <div className="cart__icon-wrap">
                    <svg
                        width="25"
                        height="25"
                        viewBox="0 0 25 25"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <path
                            d="M8.68104 25C10.1639 25 11.366 23.7979 11.366 22.3151C11.366 20.8322 10.1639 19.6301 8.68104 19.6301C7.19818 19.6301 5.99609 20.8322 5.99609 22.3151C5.99609 23.7979 7.19818 25 8.68104 25Z"
                            fill="#F89345"
                        />
                        <path
                            d="M20.0175 25C21.5003 25 22.7024 23.7979 22.7024 22.3151C22.7024 20.8322 21.5003 19.6301 20.0175 19.6301C18.5346 19.6301 17.3325 20.8322 17.3325 22.3151C17.3325 23.7979 18.5346 25 20.0175 25Z"
                            fill="#F89345"
                        />
                        <path
                            d="M8.69836 4.71566C7.42018 4.69656 6.2945 3.8696 5.89413 2.65559L5.63817 1.87946C5.27003 0.770822 4.24054 0.0166738 3.07251 0H1.07371C0.744175 0 0.477051 0.267124 0.477051 0.59666C0.477051 0.926197 0.744175 1.19332 1.07371 1.19332H3.07251C3.72125 1.20765 4.2925 1.62421 4.50452 2.23749L8.03324 12.9636C8.18208 13.416 8.16855 13.9061 7.995 14.3497C7.66787 15.205 7.75603 16.1637 8.23369 16.9451C8.7302 17.7031 9.56549 18.1709 10.4712 18.1981H22.106C22.4356 18.1981 22.7027 17.931 22.7027 17.6014C22.7027 17.2719 22.4356 17.0048 22.106 17.0048H10.4711C9.9688 16.9874 9.50901 16.7183 9.248 16.2888C8.96637 15.8649 8.91064 15.3297 9.09885 14.8568L9.45682 13.9618C9.5075 13.827 9.51966 13.6811 9.49214 13.5401C9.48876 13.5228 9.48334 13.506 9.4768 13.4897C9.39199 13.2777 9.5336 13.0434 9.76074 13.02L21.4496 11.8137C22.3337 11.7342 23.0672 11.0969 23.2694 10.2326L23.6595 8.58863C24.1025 6.722 22.7037 4.925 20.7854 4.89633L8.69836 4.71566Z"
                            fill="#F89345"
                        />
                    </svg>
                    {cartItems.length ? (
                        <span className="cart__count-icon">
                            {cartItems.length}
                        </span>
                    ) : null}
                </div>

                <div className="cart__info">
                    <span className="cart__info-title">Корзина</span>
                    <span className="cart__info-rub">{priceSum} руб.</span>
                </div>
            </a>

            {isCartOpen ? (
                <div
                    onClick={hideOnOverlay}
                    ref={overlayRef}
                    className="cart__overlay"
                >
                    <div className="cart__popup">
                        <div className="cart__popup-header">
                            <h2 className="cart__title">Корзина</h2>
                            <button
                                onClick={() => setIsCartOpen(false)}
                                className="cart__close-btn"
                            >
                                Скрыть корзину
                            </button>
                        </div>
                        <ul className="cart__items-list">
                            {cartItems &&
                                !successOrder &&
                                cartItems.map((item) => {
                                    return (
                                        <li className="cart__item">
                                            <div className="cart__item-img-wrap">
                                                <img src={item.image} alt="" />
                                            </div>
                                            <div className="cart__item-info">
                                                <h3 className="cart__item-title">
                                                    {item.title}
                                                </h3>
                                                <p className="cart__item-author">
                                                    {item.authors}
                                                </p>
                                                <p className="cart__item-type">
                                                    Электронная книга
                                                </p>
                                                <p className="cart__item-id">
                                                    Артикул: {item.id}
                                                </p>
                                                <div className="cart__item-counter-wrap">
                                                    <p className="cart__item-price">
                                                        {item.price} руб.
                                                    </p>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => deleteItem(item)}
                                                className="cart__item-del-btn"
                                            >
                                                <svg
                                                    width="13"
                                                    height="13"
                                                    viewBox="0 0 13 13"
                                                    fill="none"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                >
                                                    <path
                                                        d="M12.6421 10.9196L8.2225 6.5L12.6421 2.08037C13.1193 1.60321 13.1193 0.835025 12.6421 0.357868C12.165 -0.119289 11.3968 -0.119289 10.9196 0.357868L6.5 4.7775L2.08037 0.357868C1.60321 -0.119289 0.835025 -0.119289 0.357868 0.357868C-0.119289 0.835025 -0.119289 1.60321 0.357868 2.08037L4.7775 6.5L0.357868 10.9196C-0.119289 11.3968 -0.119289 12.165 0.357868 12.6421C0.835025 13.1193 1.60321 13.1193 2.08037 12.6421L6.5 8.2225L10.9196 12.6421C11.3968 13.1193 12.165 13.1193 12.6421 12.6421C13.1159 12.165 13.1159 11.3934 12.6421 10.9196Z"
                                                        fill="#3F414D"
                                                    />
                                                </svg>
                                            </button>
                                        </li>
                                    );
                                })}
                            {!cartItems.length && !successOrder && (
                                <li className="cart__empty">
                                    <p className="cart__empty-title">
                                        Корзина пуста
                                    </p>
                                    <svg
                                        width="252"
                                        height="252"
                                        viewBox="0 0 252 252"
                                        xmlns="http://www.w3.org/2000/svg"
                                    >
                                        <g clip-path="url(#clip0_176:99)">
                                            <path
                                                d="M157.013 163.887C156.461 164.187 155.856 164.329 155.255 164.329C154.301 164.329 153.356 163.96 152.647 163.251L127.083 137.688C126.384 136.989 126 136.044 126 135.074C126 136.044 125.616 136.989 124.917 137.688L99.3526 163.251C98.6439 163.96 97.6989 164.329 96.744 164.329C96.1436 164.329 95.5382 164.187 94.9869 163.887L31.2539 129.343V199.079C31.2534 199.207 31.2598 199.334 31.2726 199.46C31.278 199.513 31.2884 199.566 31.2958 199.618C31.3051 199.683 31.3125 199.747 31.3253 199.811C31.3411 199.891 31.3627 199.969 31.3834 200.047C31.3932 200.083 31.4006 200.12 31.4114 200.156C31.4356 200.236 31.4646 200.312 31.4936 200.39C31.5064 200.424 31.5173 200.459 31.5315 200.493C31.5601 200.563 31.593 200.63 31.6255 200.697C31.6457 200.739 31.6639 200.78 31.6856 200.821C31.7151 200.876 31.7476 200.929 31.7796 200.982C31.8101 201.032 31.8391 201.084 31.8716 201.134C31.8987 201.175 31.9292 201.214 31.9583 201.253C32.0001 201.311 32.0414 201.369 32.0867 201.425C32.1118 201.456 32.1399 201.485 32.166 201.515C32.2181 201.575 32.2703 201.635 32.3264 201.691C32.3559 201.721 32.3874 201.748 32.418 201.776C32.4741 201.829 32.5292 201.882 32.5887 201.931C32.6463 201.979 32.7074 202.022 32.7674 202.066C32.8028 202.093 32.8358 202.12 32.8722 202.145C32.9781 202.217 33.0878 202.283 33.201 202.344L124.244 251.556C124.792 251.852 125.396 252 126 252C126.604 252 127.208 251.852 127.755 251.556L218.798 202.344C218.911 202.283 219.021 202.216 219.127 202.145C219.163 202.12 219.197 202.093 219.232 202.066C219.292 202.022 219.353 201.979 219.41 201.931C219.47 201.882 219.525 201.829 219.581 201.776C219.611 201.748 219.643 201.721 219.672 201.691C219.728 201.635 219.78 201.575 219.833 201.515C219.859 201.485 219.887 201.456 219.912 201.425C219.957 201.37 219.998 201.312 220.04 201.253C220.069 201.214 220.1 201.175 220.127 201.134C220.159 201.084 220.188 201.033 220.219 200.982C220.251 200.929 220.284 200.876 220.313 200.821C220.335 200.78 220.353 200.739 220.373 200.697C220.405 200.63 220.438 200.563 220.467 200.493C220.481 200.459 220.492 200.424 220.505 200.39C220.534 200.313 220.563 200.236 220.587 200.156C220.598 200.12 220.605 200.083 220.615 200.047C220.636 199.969 220.657 199.891 220.673 199.811C220.686 199.747 220.693 199.683 220.703 199.618C220.71 199.566 220.721 199.513 220.726 199.46C220.739 199.334 220.745 199.207 220.745 199.079V129.343L157.013 163.887Z"
                                                fill="#E2AE83"
                                            />
                                            <path
                                                d="M124.065 32.5061C125.089 31.9553 125.793 30.9459 125.96 29.7941C125.985 29.6174 125.999 29.4403 125.999 29.2626C125.999 29.4403 126.014 29.6174 126.039 29.7892C126.206 30.9409 126.91 31.9455 127.934 32.5012L218.989 81.72C219.545 82.0208 220.145 82.163 220.746 82.163C220.145 82.163 219.545 82.3111 218.989 82.6109L127.934 131.83C126.91 132.381 126.206 133.39 126.039 134.542C126.014 134.719 125.999 134.897 125.999 135.073C125.999 134.897 125.985 134.719 125.96 134.542C125.793 133.39 125.089 132.381 124.065 131.83L33.0102 82.6109C32.5229 82.3505 32.0012 82.2024 31.4795 82.1679C32.0012 82.1335 32.5229 81.9863 33.0102 81.725L124.065 32.5061Z"
                                                fill="#C48D69"
                                            />
                                            <path
                                                d="M249.716 52.3718C249.884 53.5236 249.505 54.6846 248.683 55.5115L223.365 81.0718C222.656 81.7899 221.706 82.164 220.746 82.164C220.146 82.164 219.545 82.0218 218.989 81.721L127.934 32.5022C126.911 31.9465 126.207 30.942 126.039 29.7902C126.015 29.618 126 29.4413 126 29.2636C126 29.2587 126 29.2587 126 29.2538C126 28.2846 126.384 27.3386 127.083 26.6456L152.647 1.08088C153.799 -0.0757608 155.576 -0.331207 157.013 0.446451L247.822 49.6653C248.845 50.2156 249.544 51.2201 249.716 52.3718Z"
                                                fill="#D39C72"
                                            />
                                            <path
                                                d="M248.683 108.82C249.505 109.647 249.884 110.809 249.716 111.961C249.544 113.108 248.845 114.111 247.822 114.668L157.013 163.887C156.462 164.187 155.856 164.329 155.256 164.329C154.301 164.329 153.356 163.96 152.647 163.252L127.083 137.688C126.384 136.989 126 136.044 126 135.074C126 134.897 126.015 134.72 126.039 134.542C126.207 133.39 126.911 132.382 127.934 131.83L218.989 82.6113C219.545 82.3116 220.146 82.1635 220.746 82.1635C221.706 82.1635 222.656 82.5424 223.365 83.2566L248.683 108.82Z"
                                                fill="#F2C397"
                                            />
                                            <path
                                                d="M248.682 108.82L223.364 83.2566C222.655 82.5424 221.705 82.1635 220.746 82.1635C220.145 82.1635 219.545 82.3116 218.988 82.6113L209.375 87.8108C209.931 87.5111 210.532 87.3629 211.132 87.3629C212.092 87.3629 213.042 87.7419 213.751 88.4561L239.069 114.02C239.891 114.847 240.27 116.009 240.102 117.161C239.93 118.307 239.231 119.311 238.207 119.868L247.821 114.668C248.845 114.111 249.544 113.108 249.716 111.961C249.883 110.809 249.504 109.647 248.682 108.82Z"
                                                fill="#E2AE83"
                                            />
                                            <path
                                                d="M125.999 29.2532C125.999 29.2581 125.999 29.2581 125.999 29.2631C125.999 29.4407 125.985 29.6179 125.96 29.7946C125.793 30.9464 125.089 31.9558 124.065 32.5066L33.0103 81.7254C32.523 81.9868 32.0013 82.134 31.4796 82.1684C31.3762 82.1635 31.2679 82.1635 31.1646 82.1684C30.2343 82.1492 29.3238 81.7751 28.6347 81.0812L3.31656 55.5159C2.49461 54.689 2.11562 53.528 2.28296 52.3762C2.45523 51.2294 3.15414 50.2249 4.17789 49.6692L94.9867 0.450352C96.4239 -0.327306 98.2006 -0.0669381 99.3524 1.08478L124.917 26.6495C125.616 27.3489 125.995 28.289 125.999 29.2532Z"
                                                fill="#E2AE83"
                                            />
                                            <path
                                                d="M125.96 134.542C125.985 134.72 125.999 134.897 125.999 135.074C125.999 136.044 125.616 136.989 124.917 137.688L99.3524 163.251C98.6436 163.96 97.6986 164.329 96.7438 164.329C96.1433 164.329 95.5379 164.187 94.9867 163.887L4.17789 114.668C3.15414 114.111 2.45523 113.108 2.28296 111.961C2.11562 110.809 2.49461 109.647 3.31656 108.82L28.6347 83.2566C29.3238 82.5626 30.2343 82.1885 31.1646 82.1683C31.1941 82.1733 31.2236 82.1733 31.2532 82.1733C31.327 82.1733 31.4008 82.1733 31.4796 82.1683C32.0013 82.2028 32.523 82.3509 33.0103 82.6113L124.065 131.83C125.089 132.382 125.793 133.39 125.96 134.542Z"
                                                fill="#FFD2A6"
                                            />
                                            <path
                                                d="M31.48 82.1684C31.4013 82.1733 31.3275 82.1733 31.2536 82.1733C31.2241 82.1733 31.1946 82.1733 31.165 82.1684C31.2684 82.1634 31.3767 82.1634 31.48 82.1684Z"
                                                fill="#E2AE83"
                                            />
                                            <path
                                                d="M219.679 129.921C219.631 130.014 219.581 130.048 219.531 130.002H219.53L205.978 137.347V207.078C205.978 207.206 205.972 207.333 205.96 207.458C205.954 207.512 205.944 207.564 205.936 207.617C205.927 207.681 205.92 207.746 205.907 207.809C205.891 207.89 205.869 207.968 205.849 208.046C205.839 208.082 205.832 208.118 205.821 208.154C205.797 208.234 205.768 208.311 205.739 208.388C205.726 208.423 205.715 208.458 205.701 208.492C205.672 208.561 205.639 208.628 205.607 208.696C205.587 208.737 205.568 208.778 205.547 208.82C205.517 208.874 205.485 208.928 205.453 208.98C205.423 209.031 205.393 209.082 205.361 209.132C205.334 209.174 205.303 209.212 205.274 209.251C205.232 209.31 205.191 209.368 205.145 209.424C205.12 209.455 205.092 209.483 205.066 209.513C205.014 209.574 204.962 209.633 204.906 209.69C204.876 209.72 204.845 209.747 204.815 209.775C204.759 209.827 204.704 209.88 204.644 209.929C204.586 209.977 204.525 210.021 204.465 210.065C204.43 210.091 204.397 210.118 204.36 210.143C204.336 210.159 204.31 210.173 204.286 210.189L218.799 202.344C218.912 202.282 219.022 202.216 219.128 202.145C219.164 202.12 219.197 202.092 219.232 202.066C219.293 202.022 219.354 201.978 219.411 201.931C219.471 201.881 219.526 201.829 219.582 201.776C219.612 201.748 219.644 201.721 219.673 201.691C219.729 201.634 219.781 201.575 219.833 201.514C219.859 201.484 219.888 201.456 219.913 201.425C219.958 201.369 219.999 201.311 220.041 201.252C220.07 201.213 220.101 201.175 220.128 201.133C220.16 201.083 220.189 201.032 220.22 200.981C220.252 200.928 220.285 200.875 220.314 200.821C220.335 200.779 220.354 200.738 220.374 200.697C220.406 200.629 220.439 200.562 220.468 200.493C220.482 200.458 220.493 200.424 220.506 200.389C220.535 200.312 220.564 200.235 220.588 200.155C220.599 200.12 220.606 200.083 220.616 200.047C220.637 199.969 220.658 199.891 220.674 199.81C220.687 199.747 220.694 199.682 220.704 199.618C220.711 199.565 220.722 199.513 220.727 199.459C220.739 199.333 220.746 199.206 220.745 199.079V129.343L219.679 129.921Z"
                                                fill="#D39C72"
                                            />
                                            <path
                                                d="M124.917 137.688L99.3527 163.251C98.6439 163.96 97.6989 164.329 96.7441 164.329C96.1436 164.329 95.5382 164.187 94.9869 163.887L31.2539 129.343V199.079C31.2534 199.207 31.2598 199.334 31.2726 199.46C31.278 199.513 31.2884 199.566 31.2958 199.618C31.3051 199.683 31.3125 199.747 31.3253 199.811C31.3411 199.891 31.3627 199.969 31.3834 200.047C31.3932 200.083 31.4006 200.12 31.4114 200.156C31.4356 200.236 31.4646 200.312 31.4936 200.39C31.5064 200.424 31.5173 200.459 31.5315 200.493C31.5601 200.563 31.593 200.63 31.6255 200.697C31.6457 200.739 31.6639 200.78 31.6856 200.821C31.7151 200.876 31.7476 200.929 31.7796 200.982C31.8101 201.032 31.8391 201.084 31.8716 201.134C31.8987 201.175 31.9292 201.214 31.9583 201.253C32.0001 201.311 32.0414 201.369 32.0867 201.425C32.1118 201.456 32.1399 201.485 32.166 201.515C32.2181 201.575 32.2703 201.635 32.3264 201.691C32.3559 201.721 32.3874 201.748 32.418 201.776C32.4741 201.829 32.5292 201.882 32.5887 201.931C32.6463 201.979 32.7074 202.022 32.7674 202.066C32.8028 202.093 32.8358 202.12 32.8722 202.145C32.9781 202.217 33.0878 202.283 33.201 202.344L124.244 251.556C124.792 251.852 125.396 252 126 252V135.074C126 136.044 125.616 136.989 124.917 137.688Z"
                                                fill="#F2C397"
                                            />
                                        </g>
                                        <defs>
                                            <clipPath id="clip0_176:99">
                                                <rect
                                                    width="252"
                                                    height="252"
                                                    fill="white"
                                                />
                                            </clipPath>
                                        </defs>
                                    </svg>
                                    <a
                                        onClick={() => setIsCartOpen(false)}
                                        className="cart__back-to-page-btn"
                                        href="#"
                                    >
                                        Вернуться на страницу
                                    </a>
                                </li>
                            )}
                            {successOrder && (
                                <li className="cart__order-success">
                                    <img
                                        src={imgSuccess}
                                        alt="success"
                                        width="200px"
                                    />
                                    <p>
                                        Заказ #{orderNum} оформлен и добавлен в
                                        <Link
                                            onClick={() => setIsCartOpen(false)}
                                            to="/history"
                                        >
                                            историю заказов
                                        </Link>
                                    </p>
                                </li>
                            )}
                        </ul>

                        {cartItems.length ? (
                            <>
                                <button
                                    onClick={clearingCart}
                                    className="cart__clear-btn"
                                >
                                    Очистить корзину
                                </button>
                                <div className="cart__footer">
                                    <div className="cart__footer-price">
                                        <span>Итого:</span>
                                        <span>{priceSum} руб.</span>
                                    </div>
                                    <button
                                        onClick={addToMyOrders}
                                        className="cart__apply-btn"
                                    >
                                        Оформить заказ
                                    </button>
                                </div>
                            </>
                        ) : null}
                    </div>
                </div>
            ) : null}
        </div>
    );
};

export default Cart;
